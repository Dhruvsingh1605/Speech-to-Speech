<!doctype html>
<html>
<head>
  <title>Avatar Client</title>
</head>
<body>
  <button onclick="start()">Start Call</button>
  <video id="video" autoplay playsinline></video>

  <script>
    let ws, pc;

    async function start() {
      console.log("ðŸš€ Starting WebRTC call...");

      // 1ï¸âƒ£ Create RTCPeerConnection early
      pc = new RTCPeerConnection({ iceServers:[{ urls:"stun:stun.l.google.com:19302" }] });

      // 2ï¸âƒ£ Setup ICE candidate callback
      pc.onicecandidate = e => {
        if (e.candidate) {
          console.log("ðŸ§© Client ICE candidate:", e.candidate);
          ws.send(JSON.stringify({ candidate: e.candidate.candidate }));
        }
      };
      pc.oniceconnectionstatechange = () =>
        console.log("ðŸŒ ICE state:", pc.iceConnectionState);

      pc.ontrack = e => {
        console.log("ðŸŽ¬ Track received:", e.streams[0]);
        document.getElementById("video").srcObject = e.streams[0];
      };

      try {
        // 3ï¸âƒ£ Get mic audio stream and add to the connection
        const micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        micStream.getTracks().forEach(track => pc.addTrack(track, micStream));
        console.log("ðŸŽ¤ Microphone captured and track added.");
      } catch (err) {
        return console.error("âŒ getUserMedia failed:", err);
      }

      // 4ï¸âƒ£ Open WebSocket for signaling
      ws = new WebSocket("ws://localhost:8080/ws");
      ws.onopen = async () => {
        console.log("âœ… WebSocket connected, creating offer...");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ sdp: offer.sdp, type: offer.type }));
      };
      ws.onerror = e => console.error("âŒ WS error", e);

      ws.onmessage = async (e) => {
        const msg = JSON.parse(e.data);
        if (msg.sdp) {
          console.log("ðŸ”„ SDP received:", msg.type);
          await pc.setRemoteDescription(new RTCSessionDescription(msg));
        } else if (msg.candidate) {
          console.log("â›³ ICE candidate from server:", msg.candidate);
          await pc.addIceCandidate(new RTCIceCandidate({ candidate: msg.candidate }));
        }
      };
    }
  </script>
</body>
</html>
